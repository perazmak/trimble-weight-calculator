<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steel Weight Calculator v27</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: sans-serif; padding: 12px; background-color: #f4f4f4; font-size: 13px; }
        .version-tag { font-size: 10px; color: #888; text-align: right; margin-bottom: 5px; }
        .section-box { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .section-title { font-weight: bold; margin-bottom: 8px; color: #005f9e; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        label { display: block; font-weight: 600; margin-bottom: 2px; font-size: 11px; color: #555; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 12px; }
        
        button { color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        #calcBtn { background-color: #005f9e; }
        #exportBtn { background-color: #28a745; display: none; margin-top: 10px; }
        
        #status { margin-top: 10px; padding: 8px; background: #fff; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; min-height: 20px; }
        #totalBox { background-color: #333; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; display: none; text-align: center; }
        #totalBox span { font-size: 20px; display: block; font-weight: bold; color: #00ccff; }

        .table-container { max-height: 300px; overflow-y: auto; display: none; margin-top: 15px; border: 1px solid #ccc; background: #fff; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
        th { background-color: #005f9e; color: white; position: sticky; top: 0; cursor: pointer; user-select: none; }
        th:hover { background-color: #004b7c; }
        tr:hover { background-color: #f9f9f9; }
        .row-err { color: #d8000c; font-weight: bold; }
        .row-alias { color: #f39c12; font-style: italic; }
    </style>
</head>
<body>
    <div class="version-tag">App Version: 27.0 (Type Defaults Updated)</div>
    <h3>Steel Weight Calc</h3>
    
    <label>1. Load Tekla .lis file</label>
    <input type="file" id="dbFile" accept=".lis,.txt">

    <div class="section-box">
        <div class="section-title">TYPE PROPERTY LOCATION</div>
        <label>Tab Name (Set)</label>
        <input type="text" id="psetType" value="ReferenceObject">
        <label>Property Name</label>
        <input type="text" id="propType" value="Common Type">
    </div>

    <div class="section-box">
        <div class="section-title">PROFILE PROPERTY LOCATION</div>
        <label>Tab Name (Set)</label>
        <input type="text" id="psetProfile" value="Pset_QuantityTakeOff">
        <label>Property Name</label>
        <input type="text" id="propProfile" value="Reference">
    </div>

    <div class="section-box">
        <div class="section-title">LENGTH PROPERTY LOCATION</div>
        <label>Tab Name (Set)</label>
        <input type="text" id="psetLength" value="Dimensions">
        <label>Property Name (mm)</label>
        <input type="text" id="propLength" value="Length">
    </div>

    <button id="calcBtn" disabled>Calculate Weights v27</button>
    <div id="status">Please load a .lis file to begin.</div>

    <div id="totalBox">
        TOTAL SELECTION WEIGHT
        <span id="totalVal">0.0000 tn</span>
    </div>

    <div class="table-container" id="resultsContainer">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th onclick="sortTable('guid')">GUID ↕</th>
                    <th onclick="sortTable('type')">Type ↕</th>
                    <th onclick="sortTable('profile')">Profile ↕</th>
                    <th onclick="sortTable('length')">mm ↕</th>
                    <th onclick="sortTable('tn')">Tn ↕</th>
                    <th onclick="sortTable('statusNote')">Status ↕</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button id="exportBtn">Export Data to CSV</button>
    </div>

    <script>
        let tcAPI;
        let weightDatabase = {};
        let lastFullData = [];
        let sortDirection = {};

        // 1. Initialize API
        TrimbleConnectWorkspace.connect(window.parent).then(api => {
            tcAPI = api;
            if (Object.keys(weightDatabase).length > 0) document.getElementById('calcBtn').disabled = false;
        });

        // 2. Load LIS File
        document.getElementById('dbFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const chunks = event.target.result.split('PROFILE_NAME');
                for (let i = 1; i < chunks.length; i++) {
                    const nameMatch = chunks[i].match(/^\s*=\s*"([^"]+)";/);
                    const weightMatch = chunks[i].match(/"WEIGHT_PER_UNIT_LENGTH"\s+([0-9\.E\+\-]+)/);
                    if (nameMatch && weightMatch) {
                        weightDatabase[nameMatch[1].trim().toUpperCase()] = parseFloat(weightMatch[1]);
                    }
                }
                document.getElementById('status').innerText = "Database loaded. Ready.";
                if (tcAPI) document.getElementById('calcBtn').disabled = false;
            };
            reader.readAsText(file);
        });

        // Plate Logic Helper
        function getPlateWeight(profileStr, lengthMm) {
            const plateRegex = /(?:FLT|PLT|PL|FL)\s*(\d+(?:\.\d+)?)[x\*](\d+(?:\.\d+)?)/i;
            const match = profileStr.match(plateRegex);
            if (match) {
                const thickness = parseFloat(match[1]);
                const width = parseFloat(match[2]);
                return thickness * width * lengthMm * 0.00000000785;
            }
            return null;
        }

        // 3. Main Calculation
        document.getElementById('calcBtn').onclick = async function() {
            const statusEl = document.getElementById('status');
            const totalValEl = document.getElementById('totalVal');
            const totalBox = document.getElementById('totalBox');
            
            totalBox.style.display = "block";
            totalValEl.innerText = "CALCULATING...";
            statusEl.innerText = "Accessing model data...";

            const psType = document.getElementById('psetType').value.trim();
            const prType = document.getElementById('propType').value.trim();
            const psProf = document.getElementById('psetProfile').value.trim();
            const prProf = document.getElementById('propProfile').value.trim();
            const psLen = document.getElementById('psetLength').value.trim();
            const prLen = document.getElementById('propLength').value.trim();

            lastFullData = [];
            let totalTonnage = 0;

            try {
                const selection = await tcAPI.viewer.getSelection();
                if (!selection || selection.length === 0) {
                    alert("Select items in the 3D model first.");
                    totalValEl.innerText = "0.0000 tn";
                    return;
                }

                for (const sel of selection) {
                    const props = await tcAPI.viewer.getObjectProperties(sel.modelId, sel.objectRuntimeIds || [sel.objectId]);
                    
                    for (const obj of props) {
                        const getVal = (pset, prop) => {
                            let s = Array.isArray(obj.properties) ? obj.properties.find(p => p.name === pset) : obj.properties[pset];
                            return Array.isArray(s?.properties || s) ? (s.properties || s).find(p => p.name === prop)?.value : (s?.properties || s)?.[prop];
                        };

                        let elemType = getVal(psType, prType);
                        let profile = getVal(psProf, prProf);
                        let lengthRaw = getVal(psLen, prLen);
                        let note = "OK", tn = 0, lengthInt = Math.round(parseFloat(lengthRaw) || 0);

                        if (!lengthRaw || isNaN(parseFloat(lengthRaw))) {
                            note = "ERR: Missing Length";
                        } else if (!profile) {
                            note = "ERR: Missing Profile";
                        } else {
                            const profileKey = profile.toString().trim().toUpperCase();
                            let kgPerM = weightDatabase[profileKey];
                            
                            // UB to UKB / UC to UKC Fallback Logic
                            if (!kgPerM) {
                                if (profileKey.startsWith("UB")) {
                                    const altKey = profileKey.replace(/^UB/, "UKB");
                                    if (weightDatabase[altKey]) {
                                        kgPerM = weightDatabase[altKey];
                                        note = "Alias used (UKB)";
                                    }
                                } else if (profileKey.startsWith("UC")) {
                                    const altKey = profileKey.replace(/^UC/, "UKC");
                                    if (weightDatabase[altKey]) {
                                        kgPerM = weightDatabase[altKey];
                                        note = "Alias used (UKC)";
                                    }
                                }
                            }
                            
                            if (kgPerM) {
                                tn = (lengthInt / 1000) * kgPerM / 1000;
                            } else {
                                const pWt = getPlateWeight(profileKey, lengthInt);
                                if (pWt) {
                                    tn = pWt;
                                    note = "Plate Calc (Not in LIS)";
                                } else {
                                    note = "ERR: Not in LIS";
                                }
                            }
                        }

                        totalTonnage += tn;
                        lastFullData.push({
                            guid: obj.guid || "N/A",
                            type: elemType || "N/A",
                            profile: profile || "N/A",
                            length: lengthInt,
                            tn: tn.toFixed(4),
                            statusNote: note
                        });
                    }
                }

                renderTable();
                totalValEl.innerText = totalTonnage.toFixed(4) + " tn";
                statusEl.innerText = `Calculated ${lastFullData.length} objects.`;
            } catch (err) {
                alert("Error: " + err.message);
                totalValEl.innerText = "Error";
            }
        };

        function renderTable() {
            const tbody = document.querySelector("#resultsTable tbody");
            tbody.innerHTML = "";
            lastFullData.forEach(row => {
                const tr = document.createElement("tr");
                if (row.statusNote.startsWith("ERR")) tr.className = "row-err";
                else if (row.statusNote.startsWith("Alias")) tr.className = "row-alias";
                
                tr.innerHTML = `<td>${row.guid}</td><td>${row.type}</td><td>${row.profile}</td><td>${row.length}</td><td>${row.tn}</td><td>${row.statusNote}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('resultsContainer').style.display = "block";
            document.getElementById('exportBtn').style.display = "block";
        }

        function sortTable(column) {
            sortDirection[column] = !sortDirection[column];
            lastFullData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                if (!isNaN(valA) && !isNaN(valB)) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }
                if (valA < valB) return sortDirection[column] ? -1 : 1;
                if (valA > valB) return sortDirection[column] ? 1 : -1;
                return 0;
            });
            renderTable();
        }

        document.getElementById('exportBtn').onclick = function() {
            let csv = "data:text/csv;charset=utf-8,GUID,Type,Profile,Length_mm,Weight_tn,Status\n";
            lastFullData.forEach(r => {
                csv += `${r.guid},${r.type},${r.profile},${r.length},${r.tn},${r.statusNote.replace(/,/g, "")}\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", "steel_audit_report.csv");
            link.click();
        };
    </script>
</body>
</html>
