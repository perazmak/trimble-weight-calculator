<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steel Weight Calculator v6</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: #f4f4f4; font-size: 13px; }
        .version-tag { font-size: 10px; color: #888; text-align: right; }
        .section-box { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .section-title { font-weight: bold; margin-bottom: 5px; color: #005f9e; font-size: 11px; text-transform: uppercase; }
        label { display: block; font-weight: 600; margin-bottom: 2px; font-size: 11px; }
        input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 8px; font-size: 12px; }
        button { color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 5px; }
        #calcBtn { background-color: #005f9e; }
        #auditBtn { background-color: #6c757d; }
        #exportBtn { background-color: #28a745; display: none; }
        #resetBtn { background-color: #f8f9fa; color: #333; border: 1px solid #ccc; font-size: 11px; margin-top: 15px;}
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 10px; padding: 8px; background: #fff; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; }
        .table-container { max-height: 250px; overflow-y: auto; display: none; margin-top: 10px; border: 1px solid #ccc; background: #fff; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { border: 1px solid #eee; padding: 4px; text-align: left; }
        th { background-color: #f1f1f1; position: sticky; top: 0; }
        .row-err { background-color: #fff0f0; }
    </style>
</head>
<body>
    <div class="version-tag">v6.0 (GUID & Tonnes)</div>
    <h3>Steel Weight Calc</h3>
    
    <label>1. Load Tekla .lis file</label>
    <input type="file" id="dbFile" accept=".lis,.txt">

    <div class="section-box">
        <div class="section-title">PROFILE PROPERTY</div>
        <label>Set (Tab Name)</label>
        <input type="text" id="psetProfile" value="Object">
        <label>Property Name</label>
        <input type="text" id="propProfile" value="Name">
    </div>

    <div class="section-box">
        <div class="section-title">LENGTH PROPERTY (mm)</div>
        <label>Set (Tab Name)</label>
        <input type="text" id="psetLength" value="Object">
        <label>Property Name</label>
        <input type="text" id="propLength" value="Length">
    </div>

    <button id="calcBtn" disabled>Calculate weights v6</button>
    <button id="auditBtn">Visual Audit (Colors)</button>
    
    <div id="status">Ready. Load .lis file.</div>
    
    <button id="exportBtn">Export Full CSV (GUIDs)</button>
    <div class="table-container" id="resultsContainer">
        <table id="resultsTable">
            <thead><tr><th>GUID</th><th>Profile</th><th>Length(mm)</th><th>Weight(tn)</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <button id="resetBtn">Reset Model Colors</button>

    <script>
        let tcAPI;
        let weightDatabase = {};
        let lastFullSelection = [];

        // Parse LIS
        document.getElementById('dbFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const chunks = event.target.result.split('PROFILE_NAME');
                for (let i = 1; i < chunks.length; i++) {
                    const nameMatch = chunks[i].match(/^\s*=\s*"([^"]+)";/);
                    const weightMatch = chunks[i].match(/"WEIGHT_PER_UNIT_LENGTH"\s+([0-9\.E\+\-]+)/);
                    if (nameMatch && weightMatch) {
                        weightDatabase[nameMatch[1].trim().toUpperCase()] = parseFloat(weightMatch[1]);
                    }
                }
                document.getElementById('status').innerText = "Database loaded.";
                if (tcAPI) document.getElementById('calcBtn').disabled = false;
            };
            reader.readAsText(file);
        });

        async function initAPI() {
            try {
                tcAPI = await TrimbleConnectWorkspace.connect(window.parent);
                document.getElementById('status').innerText = "Connected.";
            } catch (err) { document.getElementById('status').innerText = "API Error."; }
        }

        async function processSelection(isVisualOnly = false) {
            const statusEl = document.getElementById('status');
            const tbody = document.querySelector("#resultsTable tbody");
            tbody.innerHTML = "";
            lastFullSelection = [];

            const psProf = document.getElementById('psetProfile').value.trim();
            const prProf = document.getElementById('propProfile').value.trim();
            const psLen = document.getElementById('psetLength').value.trim();
            const prLen = document.getElementById('propLength').value.trim();

            try {
                const selection = await tcAPI.viewer.getSelection();
                if (!selection || selection.length === 0) {
                    statusEl.innerText = "Please select parts in model.";
                    return;
                }

                let idsRed = [], idsGreen = [], idsBlue = [], idsGrey = [];

                for (const sel of selection) {
                    const objIds = sel.objectRuntimeIds || sel.objectIds || [sel.objectId].filter(Boolean);
                    const props = await tcAPI.viewer.getObjectProperties(sel.modelId, objIds);
                    
                    for (const obj of props) {
                        let guid = obj.guid || obj.id;
                        let profSet = Array.isArray(obj.properties) ? obj.properties.find(p => p.name === psProf) : obj.properties[psProf];
                        let profile = Array.isArray(profSet?.properties || profSet) ? (profSet.properties || profSet).find(p => p.name === prProf)?.value : (profSet?.properties || profSet)?.[prProf];
                        
                        let lenSet = Array.isArray(obj.properties) ? obj.properties.find(p => p.name === psLen) : obj.properties[psLen];
                        let length = Array.isArray(lenSet?.properties || lenSet) ? (lenSet.properties || lenSet).find(p => p.name === prLen)?.value : (lenSet?.properties || lenSet)?.[prLen];

                        let errorReason = "";
                        let weightTn = "0.000";

                        if (!length || isNaN(parseFloat(length))) {
                            errorReason = "Missing Length";
                            idsRed.push(obj.id);
                        } else if (!profile) {
                            errorReason = "Missing Profile";
                            idsGreen.push(obj.id);
                        } else {
                            const weightKgPerM = weightDatabase[profile.toString().toUpperCase()];
                            if (!weightKgPerM) {
                                errorReason = "Profile not in database";
                                idsBlue.push(obj.id);
                            } else {
                                const lMm = parseFloat(length);
                                const totalWeightTn = (lMm / 1000) * weightKgPerM / 1000;
                                weightTn = totalWeightTn.toFixed(3);
                                idsGrey.push(obj.id);
                            }
                        }

                        lastFullSelection.push({ 
                            guid: guid, 
                            profile: profile || "N/A", 
                            length: length || "N/A", 
                            weight: weightTn, 
                            error: errorReason 
                        });

                        const tr = document.createElement("tr");
                        if (errorReason) tr.className = "row-err";
                        tr.innerHTML = `<td>${guid}</td><td>${profile || "ERR"}</td><td>${length || "ERR"}</td><td>${weightTn}</td>`;
                        tbody.appendChild(tr);
                    }
                }

                if (isVisualOnly) {
                    await tcAPI.viewer.setObjectsOpacity(null, 0.1); // Model Transparent
                    if (idsRed.length > 0) await tcAPI.viewer.setObjectsColor(idsRed, { r: 255, g: 0, b: 0 }); // Red: Len
                    if (idsGreen.length > 0) await tcAPI.viewer.setObjectsColor(idsGreen, { r: 0, g: 255, b: 0 }); // Green: Prof
                    if (idsBlue.length > 0) await tcAPI.viewer.setObjectsColor(idsBlue, { r: 0, g: 0, b: 255 }); // Blue: DB Missing
                    if (idsGrey.length > 0) await tcAPI.viewer.setObjectsColor(idsGrey, { r: 128, g: 128, b: 128 }); // Grey: Success
                    statusEl.innerText = "Visual Audit applied. Check model colors.";
                } else {
                    document.getElementById('resultsContainer').style.display = "block";
                    document.getElementById('exportBtn').style.display = "block";
                    statusEl.innerText = `Processed ${lastFullSelection.length} parts.`;
                }
            } catch (err) { statusEl.innerText = "Error: " + err.message; }
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,GUID,Section Size,Length (mm),Weight (tn),Notes\n";
            lastFullSelection.forEach(row => {
                csvContent += `${row.guid},${row.profile},${row.length},${row.weight},${row.error}\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI
