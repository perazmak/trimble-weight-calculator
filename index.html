<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steel Weight Calculator v23</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; background-color: #f4f4f4; font-size: 12px; }
        .box { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 4px; margin-bottom: 8px; }
        label { display: block; font-weight: bold; margin-bottom: 2px; font-size: 10px; color: #666; }
        input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; }
        button { color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        #calcBtn { background-color: #005f9e; }
        .btn-sel { background-color: #6c757d; width: 48%; font-size: 10px; display: inline-block; }
        #exportBtn { background-color: #28a745; display: none; margin-top: 10px; }
        #status { margin: 8px 0; font-size: 11px; font-style: italic; color: #444; }
        .table-container { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background: #fff; display: none; margin-top: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { border: 1px solid #eee; padding: 5px; text-align: left; }
        th { background-color: #005f9e; color: white; position: sticky; top: 0; cursor: pointer; }
        .err-row { color: #d00; }
        #totalBox { background: #333; color: #0cf; padding: 8px; border-radius: 4px; text-align: center; display: none; margin-top: 8px; font-weight: bold; }
    </style>
</head>
<body>
    <div style="text-align:right; font-size:9px; color:#999;">v23.0 - Atomic Selection</div>
    
    <label>1. LOAD TEKLA LIS</label>
    <input type="file" id="dbFile" accept=".lis,.txt">

    <div class="box">
        <label>IFC PROPERTY PATHS</label>
        <input type="text" id="psP" value="Pset_QuantityTakeOff">
        <input type="text" id="prP" value="Reference">
        <input type="text" id="psL" value="Dimensions">
        <input type="text" id="prL" value="Length">
    </div>

    <button id="calcBtn">CALCULATE WEIGHTS</button>
    
    <div style="display:flex; gap:4px;">
        <button id="selErrBtn" class="btn-sel">SELECT ERRORS</button>
        <button id="selPltBtn" class="btn-sel">SELECT PLATES</button>
    </div>

    <div id="status">Ready.</div>

    <div id="totalBox">TOTAL: <span id="totalVal">0.0000</span> tn</div>

    <div class="table-container" id="uiTable">
        <table id="resTable">
            <thead>
                <tr>
                    <th onclick="resort(0)">GUID ↕</th>
                    <th onclick="resort(1)">Profile ↕</th>
                    <th onclick="resort(2)">mm ↕</th>
                    <th onclick="resort(3)">Tn ↕</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <button id="exportBtn">EXPORT CSV</button>

    <script>
        let tcAPI;
        let weightDB = {};
        let results = [];
        let errorIds = []; // Red
        let plateIds = []; // Yellow

        TrimbleConnectWorkspace.connect(window.parent).then(api => { tcAPI = api; });

        document.getElementById('dbFile').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = event => {
                const chunks = event.target.result.split('PROFILE_NAME');
                for (let i = 1; i < chunks.length; i++) {
                    const n = chunks[i].match(/^\s*=\s*"([^"]+)";/);
                    const w = chunks[i].match(/"WEIGHT_PER_UNIT_LENGTH"\s+([0-9\.E\+\-]+)/);
                    if (n && w) weightDB[n[1].trim().toUpperCase()] = parseFloat(w[1]);
                }
                document.getElementById('status').innerText = "LIS Data Loaded.";
            };
            reader.readAsText(e.target.files[0]);
        });

        document.getElementById('calcBtn').onclick = async () => {
            if (!tcAPI) return;
            const tbody = document.querySelector("#resTable tbody");
            tbody.innerHTML = "";
            results = []; errorIds = []; plateIds = [];
            let total = 0;

            try {
                const sel = await tcAPI.viewer.getSelection();
                if (!sel || sel.length === 0) { alert("Select objects first."); return; }

                for (const s of sel) {
                    const props = await tcAPI.viewer.getObjectProperties(s.modelId, s.objectRuntimeIds || [s.objectId]);
                    for (const o of props) {
                        const get = (pset, prop) => {
                            let tab = Array.isArray(o.properties) ? o.properties.find(x => x.name === pset) : o.properties[pset];
                            return Array.isArray(tab?.properties || tab) ? (tab.properties || tab).find(x => x.name === prop)?.value : (tab?.properties || tab)?.[prop];
                        };

                        let prof = get(document.getElementById('psP').value, document.getElementById('prP').value);
                        let lenR = get(document.getElementById('psL').value, document.getElementById('prL').value);
                        let L = Math.round(parseFloat(lenR) || 0), tn = 0, note = "OK";

                        if (!prof || !lenR) { 
                            note = "ERR"; 
                            errorIds.push(o.id); 
                        } else {
                            const kgM = weightDB[prof.toString().toUpperCase()];
                            if (kgM) { 
                                tn = (L/1000) * kgM / 1000; 
                            } else {
                                const m = prof.toString().match(/(?:FLT|PLT|PL|FL)\s*(\d+(?:\.\d+)?)[x\*](\d+(?:\.\d+)?)/i);
                                if (m) {
                                    tn = parseFloat(m[1]) * parseFloat(m[2]) * L * 0.00000000785;
                                    note = "PLATE";
                                    plateIds.push(o.id);
                                } else { 
                                    note = "ERR"; 
                                    errorIds.push(o.id); 
                                }
                            }
                        }
                        total += tn;
                        results.push({ guid: o.guid||"N/A", prof: prof||"ERR", L, tn: tn.toFixed(4), note, id: o.id });

                        const tr = document.createElement("tr");
                        if (note === "ERR") tr.className = "err-row";
                        tr.innerHTML = `<td>${o.guid||"N/A"}</td><td>${prof||"ERR"}</td><td>${L}</td><td>${tn.toFixed(4)}</td>`;
                        tbody.appendChild(tr);
                    }
                }
                document.getElementById('uiTable').style.display = "block";
                document.getElementById('exportBtn').style.display = "block";
                document.getElementById('totalBox').style.display = "block";
                document.getElementById('totalVal').innerText = total.toFixed(4);
                document.getElementById('status').innerText = `Computed ${results.length} parts.`;
            } catch (err) { alert(err.message); }
        };

        // Selection Fix: Try Atomic ID Array
        async function applySelection(idArray) {
            if (!idArray.length) return;
            // Clean selection first
            await tcAPI.viewer.setSelection([]);
            // Attempt Atomic selection (passing just IDs)
            try {
                await tcAPI.viewer.setSelection(idArray);
            } catch (e) {
                // If Atomic fails, fallback to standard mapped selection
                const selection = await tcAPI.viewer.getSelection();
                const mId = selection[0].modelId;
                await tcAPI.viewer.setSelection([{ modelId: mId, objectIds: idArray }]);
            }
        }

        document.getElementById('selErrBtn').onclick = () => applySelection(errorIds);
        document.getElementById('selPltBtn').onclick = () => applySelection(plateIds);

        document.getElementById('exportBtn').onclick = () => {
            let csv = "data:text/csv;charset=utf-8,GUID,Profile,mm,Tn,Status\n";
            results.forEach(r => csv += `${r.guid},${r.prof},${r.L},${r.tn},${r.note}\n`);
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", "weights_v23.csv");
            link.click();
        };

        function resort(n) {
            results.sort((a,b) => {
                let v1 = Object.values(a)[n], v2 = Object.values(b)[n];
                return isNaN(v1) ? v1.toString().localeCompare(v2) : v1 - v2;
            });
            const tbody = document.querySelector("#resTable tbody");
            tbody.innerHTML = "";
            results.forEach(r => {
                const tr = document.createElement("tr");
                if (r.note === "ERR") tr.className = "err-row";
                tr.innerHTML = `<td>${r.guid}</td><td>${r.prof}</td><td>${r.L}</td><td>${r.tn}</td>`;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
